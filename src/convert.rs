use csv;

use std::io::{File};

pub fn convert_dispatch_latency(filename: &str) {
    let mut rdr = csv::Reader::from_file(&Path::new(filename))
                                .delimiter(b';')
                                .flexible(true);

    // Ignore comment lines generated by benchmark tool
    for _ in range(0u,3) {
      rdr.next();
    }
    // Fetch and rearrange data
    let mut data: Vec<(int, int, int)> = Vec::with_capacity(16384 * 2);
    for row in rdr.decode() {
        let (x1, x2, x3): (int, int, int) = row.unwrap();
        data.push((x1, x2 - x1, x3));
    }

    //
    // Save data
    //
    let dest_filename = "dispatch_".to_string() + String::from_str(filename);
    let mut file = File::create(&Path::new(dest_filename.as_slice()));
    // Add header
    file.write(b"requestLatency;startLatency;ExecutionTime\n")
        .ok().expect("Unable to write header line.");
    // Write data

    let mut enc = csv::Writer::from_writer(file)
                                .delimiter(b';');

    for entry in data.into_iter() {
        match enc.encode(entry) {
            Ok(_) => {},
            Err(err) => fail!("Error saving csv file: {}", err),
        }
    }

}
